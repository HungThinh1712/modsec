# ---------------------------------------------------------------
# Core ModSecurity Rule Set ver.2.2.0
# Copyright (C) 2006-2011 Trustwave All rights reserved.
#
# The OWASP ModSecurity Core Rule Set is distributed under 
# Apache Software License (ASL) version 2
# Please see the enclosed LICENCE file for full details.
# ---------------------------------------------------------------


#
# -=[ OWASP AppSensor Detection Points - Request Exceptions (RE) Category ]=-
#
# - https://www.owasp.org/index.php/AppSensor_DetectionPoints#RequestException
#
# Instead of creating rule set based on analyzing saved audit log data, we can
# instead profile live transactions in phase:5 post processing and save data in
# Resource-based persistent collections.  Once we have seen enough traffic (as
# defined below) we can then move into Enforcement Mode.
#

SecMarker BEGIN_RE_PROFILE_ENFORCEMENT

#
# Should we enforce the learned profile for this transaction?
#
# If the resource.enforce_profile parameter is not set, then we skip enforcement.
#
SecRule &RESOURCE:ENFORCE_RE_PROFILE "@eq 0" "phase:2,id:'981085',t:none,nolog,pass,skipAfter:END_RE_PROFILE_ENFORCEMENT"


#
# -=[ RE2: Attempt to Invoke Unsupported HTTP Method ]=-
#
# - https://www.owasp.org/index.php/AppSensor_DetectionPoints#RE2:_Attempt_to_Invoke_Unsupported_HTTP_Method
#
SecRule REQUEST_METHOD "!@within HEAD GET POST PUT DELETE TRACE OPTIONS CONNECT" "phase:2,id:'981086',t:none,block,msg:'Attempt to Invoke Unsupported HTTP Method.',logdata:'%{request_method}',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.error_anomaly_score},setvar:tx.profiler_score=+%{tx.error_anomaly_score},tag:'POLICY/METHOD_NOT_ALLOWED',tag:'OWASP_AppSensor/RE2',tag:'https://www.owasp.org/index.php/AppSensor_DetectionPoints#RE2:_Attempt_to_Invoke_Unsupported_HTTP_Method'"


#
# -=[ RE1: Unexpected HTTP Command ]=-
#
# - https://www.owasp.org/index.php/AppSensor_DetectionPoints#RE1:_Unexpected_HTTP_Command
#
SecRule REQUEST_METHOD "!@within %{resource.request_method_enforce}" "phase:2,id:'981087',t:none,block,msg:'Invalid Request Method for Resource.',logdata:'%{request_method}',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.error_anomaly_score},setvar:tx.profiler_score=+%{tx.error_anomaly_score},tag:'POLICY/METHOD_NOT_ALLOWED',tag:'OWASP_AppSensor/RE1',tag:'https://www.owasp.org/index.php/AppSensor_DetectionPoints#RE1:_Unexpected_HTTP_Command'"


#
# -=[ RE5: Additional/Duplicated Data in Request ]=-
#
# - https://www.owasp.org/index.php/AppSensor_DetectionPoints#RE5:_Additional.2FDuplicated_Data_in_Request
#
SecRule &ARGS "!@within %{resource.#_args_enforce}" "phase:2,id:'981088',t:none,block,msg:'Invalid Number of Parameters.',logdata:'%{matched_var}',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.error_anomaly_score},setvar:tx.profiler_score=+%{tx.error_anomaly_score},tag:'POLICY/PARAMETER_VIOLATION',tag:'OWASP_AppSensor/RE5',tag:'https://www.owasp.org/index.php/AppSensor_DetectionPoints#RE5:_Additional.2FDuplicated_Data_in_Request'"

SecRule ARGS_NAMES "!@within %{resource.args_names_enforce}" "phase:2,id:'981089',t:none,block,msg:'Invalid Parameter Name(s).',logdata:'%{matched_var}',setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.error_anomaly_score},setvar:tx.profiler_score=+%{tx.error_anomaly_score},tag:'POLICY/PARAMETER_VIOLATION',tag:'OWASP_AppSensor/RE5',tag:'https://www.owasp.org/index.php/AppSensor_DetectionPoints#RE5:_Additional.2FDuplicated_Data_in_Request'"


#
# -=[ RE7: Unexpected Quantity of Characters in Parameter ]=-
#
# - https://www.owasp.org/index.php/AppSensor_DetectionPoints#RE7:_Unexpected_Quantity_of_Characters_in_Parameter 
#
SecMarker BEGIN_ENFORCE_LENGTH

SecRule ARGS "!^$" "chain,phase:2,id:'981090',t:none,block,msg:'Invalid Parameter Length - Parameter Should Be Empty',logdata:'Parameter (%{tx.enforce_length0_name}) Length: %{tx.enforce_length0}',setvar:tx.length_check0_%{matched_var}=%{matched_var_name},tag:'POLICY/PARAMETER_VIOLATION',tag:'OWASP_AppSensor/RE7'"
        SecRule TX:/LENGTH_CHECK0_/ "@within %{resource.args_length_check0_enforce}" "chain,t:none,setvar:tx.enforce_length1_name=%{matched_var}"
		SecRule MATCHED_VAR_NAME "length_check0_(.*)$" "capture,t:none,setvar:tx.enforce_length0=%{tx.1},setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.error_anomaly_score},setvar:tx.profiler_score=+%{tx.error_anomaly_score}"


SecRule ARGS "!^[1-5]$" "chain,phase:2,id:'981091',t:none,t:length,block,msg:'Invalid Parameter Length.',logdata:'Parameter (%{tx.enforce_length1_name}) Length: %{tx.enforce_length1}',setvar:tx.length_check1_%{matched_var}=%{matched_var_name},tag:'POLICY/PARAMETER_VIOLATION',tag:'OWASP_AppSensor/RE7'"
        SecRule TX:/LENGTH_CHECK1_/ "@within %{resource.args_length_check1_enforce}" "chain,t:none,setvar:tx.enforce_length1_name=%{matched_var}"
		SecRule MATCHED_VAR_NAME "length_check1_(.*)$" "capture,t:none,setvar:tx.enforce_length1=%{tx.1},setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.error_anomaly_score},setvar:tx.profiler_score=+%{tx.error_anomaly_score}"


SecRule ARGS "!^[6-9]|10$" "chain,phase:2,id:'981092',t:none,t:length,block,msg:'Invalid Parameter Length.',logdata:'Parameter (%{tx.enforce_length2_name}) Length: %{tx.enforce_length2}',setvar:tx.length_check2_%{matched_var}=%{matched_var_name},tag:'POLICY/PARAMETER_VIOLATION',tag:'OWASP_AppSensor/RE7'"
	SecRule TX:/LENGTH_CHECK2_/ "@within %{resource.args_length_check2_enforce}" "chain,t:none,setvar:tx.enforce_length2_name=%{matched_var}"
		SecRule MATCHED_VAR_NAME "length_check2_(.*)$" "capture,t:none,setvar:tx.enforce_length2=%{tx.1},setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.error_anomaly_score},setvar:tx.profiler_score=+%{tx.error_anomaly_score}"


SecRule ARGS "!^1[1-9]|20$" "chain,phase:2,id:'981093',t:none,t:length,block,msg:'Invalid Parameter Length.',logdata:'Parameter (%{tx.enforce_length3_name}) Length: %{tx.enforce_length3}',setvar:tx.length_check3_%{matched_var}=%{matched_var_name},tag:'POLICY/PARAMETER_VIOLATION',tag:'OWASP_AppSensor/RE7'"
        SecRule TX:/LENGTH_CHECK3_/ "@within %{resource.args_length_check3_enforce}" "chain,t:none,setvar:tx.enforce_length3_name=%{matched_var}"
                SecRule MATCHED_VAR_NAME "length_check3_(.*)$" "capture,t:none,setvar:tx.enforce_length3=%{tx.1},setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.error_anomaly_score},setvar:tx.profiler_score=+%{tx.error_anomaly_score}"


SecRule ARGS "!^(2[1-9]|3[0-9]|40)$" "chain,phase:2,id:'981094',t:none,t:length,block,msg:'Invalid Parameter Length.',logdata:'Parameter (%{tx.enforce_length4_name}) Length: %{tx.enforce_length4}',setvar:tx.length_check4_%{matched_var}=%{matched_var_name},tag:'POLICY/PARAMETER_VIOLATION',tag:'OWASP_AppSensor/RE7'"
        SecRule TX:/LENGTH_CHECK4_/ "@within %{resource.args_length_check4_enforce}" "chain,t:none,setvar:tx.enforce_length4_name=%{matched_var}"
                SecRule MATCHED_VAR_NAME "length_check4_(.*)$" "capture,t:none,setvar:tx.enforce_length4=%{tx.1},setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.error_anomaly_score},setvar:tx.profiler_score=+%{tx.error_anomaly_score}"


SecRule ARGS "!^(4[1-9]|(5|6|7)[0-9]|80)$" "chain,phase:2,id:'981095',t:none,t:length,block,msg:'Invalid Parameter Length.',logdata:'Parameter (%{tx.enforce_length5_name}) Length: %{tx.enforce_length5}',setvar:tx.length_check5_%{matched_var}=%{matched_var_name},tag:'POLICY/PARAMETER_VIOLATION',tag:'OWASP_AppSensor/RE7'"
        SecRule TX:/LENGTH_CHECK5_/ "@within %{resource.args_length_check5_enforce}" "chain,t:none,setvar:tx.enforce_length5_name=%{matched_var}"
                SecRule MATCHED_VAR_NAME "length_check5_(.*)$" "capture,t:none,setvar:tx.enforce_length5=%{tx.1},setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+%{tx.error_anomaly_score},setvar:tx.profiler_score=+%{tx.error_anomaly_score}"


SecMarker END_ENFORCE_LENGTH

#
# -=[ RE8: Unexpected Type of Characters in Parameter ]=-
#
# - https://www.owasp.org/index.php/AppSensor_DetectionPoints#RE8:_Unexpected_Type_of_Characters_in_Parameter 
#

#
# Enforce pattern.digits=[0-9]+
#
SecRule ARGS "!^[0-9]+$" "chain,phase:2,id:'981096',t:none,log,block,setvar:tx.digits_check_%{matched_var}=%{matched_var_name},msg:'Invalid Character(s) in Payload - Expecting Digits.',logdata:'Parameter (%{tx.enforce_digits_name}): %{tx.enforce_digits}',tag:'OWASP_AppSensor/RE8'"
        SecRule TX:/DIGITS_CHECK_/ "@within %{resource.args_digits_enforce}" "chain,t:none,setvar:tx.enforce_digits_name=%{matched_var}"
		SecRule MATCHED_VAR_NAME "digits_check_(.*)$" "capture,t:none,setvar:tx.enforce_digits=%{tx.1},setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+20,setvar:tx.profiler_score=+1"

#
# Enforce pattern.alpha=[a-z]+
#
SecRule ARGS "!^[a-z]+$" "chain,phase:2,id:'981097',t:none,t:lowercase,log,block,setvar:tx.alpha_check_%{matched_var}=%{matched_var_name},msg:'Invalid Character(s) in Payload - Expecting Letters.',logdata:'Parameter (%{tx.enforce_alpha_name}): %{tx.enforce_alpha}',tag:'OWASP_AppSensor/RE8'"
        SecRule TX:/ALPHA_CHECK_/ "@within %{resource.args_alpha_enforce}" "chain,t:none,setvar:tx.enforce_alpha_name=%{matched_var}"
		SecRule MATCHED_VAR_NAME "alpha_check_(.*)$" "capture,t:none,setvar:tx.enforce_alpha=%{tx.1},setvar:'tx.msg=%{rule.msg}',setvar:tx.anomaly_score=+20,setvar:tx.profiler_score=+1"


SecMarker END_RE_PROFILE_ENFORCEMENT

#
# --[ Begin Profiling Phase ]--
#
SecMarker BEGIN_RE_PROFILE_ANALYSIS
SecAction "phase:5,id:'981098',t:none,nolog,pass,ctl:ruleEngine=DetectionOnly"
SecRule RESPONSE_STATUS "^404$" "phase:5,id:'981099',t:none,nolog,pass,setvar:!resource.KEY,skipAfter:END_RE_PROFILE_ANALYSIS"
SecRule RESPONSE_STATUS "^(5|4)" "phase:5,id:'981100',t:none,nolog,pass,skipAfter:END_RE_PROFILE_ANALYSIS"
SecRule TX:ANOMALY_SCORE "!@eq 0" "phase:5,id:'981101',t:none,nolog,pass,skipAfter:END_RE_PROFILE_ANALYSIS"
SecRule &RESOURCE:ENFORCE_RE_PROFILE "@eq 1" "phase:2,id:'981102',t:none,nolog,pass,skipAfter:END_RE_PROFILE_ANALYSIS"

#
# Check REQUEST_METHOD 
#
SecRule REQUEST_METHOD "@within %{resource.request_method_enforce}" "phase:5,id:'981103',t:none,nolog,pass,skipAfter:END_REQUEST_METHOD_PROFILE_CHECK"
SecRule REQUEST_METHOD "." "phase:5,id:'981104',t:none,nolog,pass,setvar:resource.request_method_count_%{matched_var}=+1"
SecRule RESOURCE:/REQUEST_METHOD_COUNT_/ "@streq %{resource.pattern_threshold}" "chain,phase:5,id:'981105',t:none,nolog,pass"
        SecRule MATCHED_VAR_NAME "request_method_count_(.*)$" "capture,setvar:'resource.request_method_enforce=%{resource.request_method_enforce} %{tx.1}',setvar:!resource.request_method_count_%{tx.1}"

SecMarker END_REQUEST_METHOD_PROFILE_CHECK

#
# Check # of parameters
#
SecRule &ARGS "@within %{resource.#_args_enforce}" "phase:5,id:'981106',t:none,nolog,pass,skipAfter:END_#_ARGS_PROFILE_CHECK"
SecRule &ARGS "." "phase:5,id:'981107',t:none,nolog,pass,setvar:resource.#_args_count_%{matched_var}=+1"
SecRule RESOURCE:/#_ARGS_COUNT_/ "@streq %{resource.pattern_threshold}" "chain,phase:5,id:'981108',t:none,nolog,pass"
	SecRule MATCHED_VAR_NAME "#_args_count_(.*)$" "capture,t:lowercase,setvar:'resource.#_args_enforce=%{resource.#_args_enforce} %{tx.1}',setvar:!resource.#_args_count_%{tx.1}"

SecMarker END_#_ARGS_PROFILE_CHECK

#
# Check parameter names
#
SecRule ARGS_NAMES "!@within %{resource.args_names_enforce}" "phase:5,id:'981109',t:none,nolog,pass,setvar:resource.args_names_count_%{matched_var}=+1"
SecRule RESOURCE:/ARGS_NAMES_COUNT_/ "@streq %{resource.pattern_threshold}" "chain,phase:5,id:'981110',t:none,nolog,pass,setvar:tx.args_names_count_%{matched_var_name}=%{matched_var_name}"
        SecRule TX:/ARGS_NAMES_COUNT_/ "args_names_count_(.*)$" "capture,t:none,setvar:'resource.args_names_enforce=%{resource.args_names_enforce} %{tx.1}',setvar:!resource.args_names_count_%{tx.1}"

SecMarker END_ARGS_NAMES_PROFILE_CHECK

#
# Check parameter lengths
#
# length check 0 - flag parameter - no data
# length check 1 - below 5 characters
# length check 2 - between 6-10 characters
# length check 3 - between 11-20 characters
# length check 4 - between 21-40 characters
# length check 5 - between 41-80 characters
# length check 6 - between 81-160 characters
# length check 7 - between 161-320 characters
#

SecMarker BEGIN_LENGTH_CHECK1

SecRule ARGS "^0$" "phase:5,id:'981111',t:none,t:length,nolog,pass,setvar:resource.args_length_check0_%{matched_var_name}=+1"
SecRule ARGS "^[1-5]$" "phase:5,id:'981112',t:none,t:length,nolog,pass,setvar:resource.args_length_check1_%{matched_var_name}=+1"
SecRule ARGS "^[6-9]|10$" "phase:5,id:'981113',t:none,t:length,nolog,pass,setvar:resource.args_length_check2_%{matched_var_name}=+1"
SecRule ARGS "^1[1-9]|20$" "phase:5,id:'981114',t:none,t:length,nolog,pass,setvar:resource.args_length_check3_%{matched_var_name}=+1"
SecRule ARGS "^(2[1-9]|3[0-9]|40)$" "phase:5,id:'981115',t:none,t:length,nolog,pass,setvar:resource.args_length_check4_%{matched_var_name}=+1"
SecRule ARGS "^(4[1-9]|(5|6|7)[0-9]|80)$" "phase:5,id:'981116',t:none,t:length,nolog,pass,setvar:resource.args_length_check5_%{matched_var_name}=+1"
#SecRule ARGS "^(8[1-9]|9[0-9]|1[0-5][0-9]|160)$" "phase:5,id:'981117',t:none,t:length,nolog,pass,setvar:resource.args_length_check6_%{matched_var_name}=+1"
#SecRule ARGS "^(1[6-9][0-9]|2[0-9[0-9]|3[0-2][0-9])$" "phase:5,id:'981118',t:none,t:length,nolog,pass,setvar:resource.args_length_check7_%{matched_var_name}=+1"
SecMarker END_LENGTH_CHECK1

SecRule RESOURCE:/ARGS_LENGTH_CHECK0_/ "!@within %{resource.args_length_check0_enforce}" "chain,phase:5,id:'981119',t:none,nolog,pass"
	SecRule RESOURCE:/ARGS_LENGTH_CHECK0_/ "@streq %{resource.pattern_threshold}" "chain,setvar:tx.args_length_check0_%{matched_var_name}=%{matched_var_name}"
		SecRule TX:/ARGS_LENGTH_CHECK0_/ "args_length_check0_(.*)$" "capture,t:none,setvar:'resource.args_length_check0_enforce=%{resource.args_length_check0_enforce} %{tx.1}',setvar:!resource.args_length_check0_%{tx.1}"


SecRule RESOURCE:/ARGS_LENGTH_CHECK1_/ "!@within %{resource.args_length_check1_enforce}" "chain,phase:5,id:'981120',t:none,nolog,pass"
	SecRule RESOURCE:/ARGS_LENGTH_CHECK1_/ "@streq %{resource.pattern_threshold}" "chain,setvar:tx.args_length_check1_%{matched_var_name}=%{matched_var_name}"
                SecRule TX:/ARGS_LENGTH_CHECK1_/ "args_length_check1_(.*)$" "capture,t:none,setvar:'resource.args_length_check1_enforce=%{resource.args_length_check1_enforce} %{tx.1}',setvar:!resource.args_length_check1_%{tx.1}"


SecRule RESOURCE:/ARGS_LENGTH_CHECK2_/ "!@within %{resource.args_length_check2_enforce}" "chain,phase:5,id:'981121',t:none,nolog,pass"
        SecRule RESOURCE:/ARGS_LENGTH_CHECK2_/ "@streq %{resource.pattern_threshold}" "chain,setvar:tx.args_length_check2_%{matched_var_name}=%{matched_var_name}"
                SecRule TX:/ARGS_LENGTH_CHECK2_/ "args_length_check2_(.*)$" "capture,t:none,setvar:'resource.args_length_check2_enforce=%{resource.args_length_check2_enforce} %{tx.1}',setvar:!resource.args_length_check2_%{tx.1}"


SecRule RESOURCE:/ARGS_LENGTH_CHECK3_/ "!@within %{resource.args_length_check3_enforce}" "chain,phase:5,id:'981122',t:none,nolog,pass"
        SecRule RESOURCE:/ARGS_LENGTH_CHECK3_/ "@streq %{resource.pattern_threshold}" "chain,setvar:tx.args_length_check3_%{matched_var_name}=%{matched_var_name}"
                SecRule TX:/ARGS_LENGTH_CHECK3_/ "args_length_check3_(.*)$" "capture,t:none,setvar:'resource.args_length_check3_enforce=%{resource.args_length_check3_enforce} %{tx.1}',setvar:!resource.args_length_check3_%{tx.1}"


SecRule RESOURCE:/ARGS_LENGTH_CHECK4_/ "!@within %{resource.args_length_check4_enforce}" "chain,phase:5,id:'981123',t:none,nolog,pass"
        SecRule RESOURCE:/ARGS_LENGTH_CHECK4_/ "@streq %{resource.pattern_threshold}" "chain,setvar:tx.args_length_check4_%{matched_var_name}=%{matched_var_name}"
                SecRule TX:/ARGS_LENGTH_CHECK4_/ "args_length_check4_(.*)$" "capture,t:none,setvar:'resource.args_length_check4_enforce=%{resource.args_length_check4_enforce} %{tx.1}',setvar:!resource.args_length_check4_%{tx.1}"


SecRule RESOURCE:/ARGS_LENGTH_CHECK5_/ "!@within %{resource.args_length_check5_enforce}" "chain,phase:5,id:'981124',t:none,nolog,pass"
        SecRule RESOURCE:/ARGS_LENGTH_CHECK5_/ "@streq %{resource.pattern_threshold}" "chain,setvar:tx.args_length_check5_%{matched_var_name}=%{matched_var_name}"
                SecRule TX:/ARGS_LENGTH_CHECK5_/ "args_length_check5_(.*)$" "capture,t:none,setvar:'resource.args_length_check5_enforce=%{resource.args_length_check5_enforce} %{tx.1}',setvar:!resource.args_length_check5_%{tx.1}"


#
# Check pattern.digits=[0-9]+
#
SecRule ARGS "^[0-9]+$" "phase:5,id:'981125',t:none,nolog,pass,setvar:resource.%{matched_var_name}_digits=+1"
SecRule RESOURCE:'/ARGS.*digits$/' "@streq %{resource.pattern_threshold}" "chain,phase:5,id:'981126',t:none,nolog,pass,setvar:tx.args_digits_%{matched_var_name}=%{matched_var_name}"
	SecRule TX:/ARGS_DIGITS_/ "(ARGS:.*)_digits$" "capture,t:none,setvar:'resource.args_digits_enforce=%{resource.args_digits_enforce} %{tx.1}'"


#
# Check pattern.alpha=[a-z]+
#
SecRule ARGS "^[a-z]+$" "phase:5,id:'981127',t:none,t:lowercase,nolog,pass,setvar:resource.%{matched_var_name}_alpha=+1"
SecRule RESOURCE:'/ARGS.*alpha$/' "@streq %{resource.pattern_threshold}" "chain,phase:5,id:'981128',t:none,nolog,pass,setvar:tx.args_alpha_%{matched_var_name}=%{matched_var_name}"
        SecRule TX:/ARGS_ALPHA_/ "(ARGS:.*)_alpha$" "capture,t:none,setvar:'resource.args_alpha_enforce=%{resource.args_alpha_enforce} %{tx.1}'"


SecAction "phase:5,id:'981129',t:none,nolog,pass,setvar:resource.confidence_counter=+1"
SecRule RESOURCE:CONFIDENCE_COUNTER "@streq %{resource.confidence_counter_threshold}" "phase:5,id:'981130',t:none,nolog,pass,setvar:resource.enforce_re_profile=1" 
SecMarker END_RE_PROFILE_ANALYSIS

